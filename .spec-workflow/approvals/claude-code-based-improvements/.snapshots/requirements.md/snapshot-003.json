{
  "id": "snapshot_1771011978002_8wogkwsqn",
  "approvalId": "approval_1771010196829_b5igrco6l",
  "approvalTitle": "Requirements approval (rev2) - claude-code-based-improvements",
  "version": 3,
  "timestamp": "2026-02-13T19:46:18.002Z",
  "trigger": "approved",
  "status": "pending",
  "content": "---\nspw:\n  schema: 1\n  spec: \"claude-code-based-improvements\"\n  doc: \"requirements\"\n  status: \"draft\"\n  source: \"spw:prd\"\n  updated_at: \"2026-02-13\"\n  inputs:\n    - \"https://github.com/anthropics/claude-code\"\n  open_questions: []\n  risk: \"medium\"\n---\n\n# Requirements Document\n\n## Product Context\n- Business problem: Critical rules still rely too heavily on prompt markdown and have only partial enforcement.\n- Feature objective: Move validations and guardrails into `spw` CLI commands (Go), making the workflow more deterministic.\n- Target audience: SPW maintainers and operators of `spw:*` commands.\n\n## Scope\n### In Scope\n- New CLI command for prompt/workflow validation (`spw validate prompts`).\n- Full status.json contract enforcement by the CLI (closing the gap between what `dispatch-setup` documents and what `dispatch-read-status` validates).\n- \"High-signal only\" gate for audit commands with configurable confidence threshold.\n- Explicit revision/replanning attempt limits.\n- Go test coverage for new contracts.\n\n### Out of Scope\n- Rewriting dispatch categories.\n- Changing the macro workflow `prd -> plan -> exec -> checkpoint -> qa`.\n- Creating new MCP artifacts beyond `requirements.md`, `design.md`, `tasks.md`.\n\n## Functional Requirements\n\n### REQ-001 - Mandatory frontmatter validation for commands\n- User story: As a maintainer, I want to enforce a minimum contract on `commands/spw/*.md`.\n- Acceptance criteria (EARS):\n  - WHEN `spw validate prompts` runs THEN each command MUST contain `description`, `argument-hint`, `allowed-tools`, `model`.\n  - IF any required field is missing THEN the command fails with an explicit list of violations.\n  - WHEN `spw validate prompts --json` runs THEN output is machine-parseable JSON with `ok`, `summary`, `violations[]`, `stats` fields (suitable for CI pipelines).\n- Priority: Must\n\n### REQ-002 - Mirror and embedded asset validation\n- User story: As a maintainer, I want to detect drift automatically.\n- Acceptance criteria (EARS):\n  - WHEN `spw validate prompts --strict` runs THEN it must validate consistency between `commands/`, `workflows/`, `copy-ready/` and CLI embedded assets.\n  - IF there is a divergence THEN it must fail with pairs of divergent paths.\n- Priority: Must\n\n### REQ-003 - Full status.json contract enforcement\n- User story: As an orchestrator, I want structured status for reliable decision-making.\n- Context: The current status.json has two core fields (`status`, `summary`) validated by the CLI, but `dispatch-setup` already documents extended fields (`skills_used`, `skills_missing`, `model_override_reason`) that are not validated. This requirement closes that gap — no version bump needed, just enforcing the full existing contract.\n- Acceptance criteria (EARS):\n  - WHEN `spw tools dispatch-setup` generates a brief THEN the output contract section must list all required fields: `status`, `summary`, `skills_used`, `skills_missing`, `model_override_reason`.\n  - WHEN `spw tools dispatch-read-status` reads status THEN it validates all fields including extended ones (types, required vs optional).\n  - IF invalid THEN it returns `valid=false` and `errors[]` per field.\n- Priority: Must\n\n### REQ-004 - High-signal gate for audits\n- User story: As a maintainer, I want to reduce false positives in audit commands.\n- Context: Currently audit decisions are binary (pass/blocked). This adds a confidence dimension so low-confidence blockers become warnings instead of hard blocks.\n- Acceptance criteria (EARS):\n  - WHEN a finding is blocking THEN it MUST have `validated=true` and `confidence >= audit_min_confidence`.\n  - IF the threshold is not met THEN it becomes a warning, not a blocker.\n  - The `audit_min_confidence` value MUST be configurable in `spw-config.toml` under a new `[audit]` section (e.g. `audit_min_confidence = 0.8`).\n- Priority: Must\n\n### REQ-005 - Iteration limits\n- User story: As an operator, I want to avoid indefinite loops.\n- Acceptance criteria (EARS):\n  - WHEN revision/replanning cycles occur THEN they MUST respect `max_revision_attempts` and `max_replan_attempts`.\n  - IF the limit is exceeded THEN the result MUST be `WAITING_FOR_HUMAN_DECISION` with an explicit action.\n- Priority: Should\n\n### REQ-006 - Documentation update in the same patch\n- User story: As a maintainer, I want to avoid doc/behavior drift.\n- Acceptance criteria (EARS):\n  - WHEN behavior/defaults/guardrails change THEN the patch MUST update `README.md`, `AGENTS.md`, `docs/SPW-WORKFLOW.md`, `hooks/README.md`, `copy-ready/README.md`.\n- Priority: Must\n\n### REQ-007 - Regression test coverage\n- User story: As a maintainer, I want confidence in safe evolution.\n- Acceptance criteria (EARS):\n  - WHEN Go tests run THEN new contracts (validator/frontmatter/status enforcement/high-signal) MUST be covered.\n- Priority: Must\n\n## Non-Functional Requirements\n- Performance: `spw validate prompts` must complete in under 2 seconds on the standard repository.\n- Security: Local-only validation, no external calls.\n- Observability: Error messages must include rule + path + reason.\n- Accessibility (when applicable): N/A (CLI).\n\n## Constraints and Assumptions\n- Technical constraints: Implementation focused on Go CLI (Cobra + internal packages).\n- External dependencies: No new required dependencies beyond those already in use.\n- Assumptions:\n  - No backward compatibility needed — the extended fields are already documented in briefs but simply not validated yet.\n  - Markdown workflows remain declarative; central enforcement lives in the CLI.\n\n## Success Criteria\n- Metric 1: 100% of `commands/spw/*.md` with `allowed-tools` and `model`.\n- Metric 2: 100% of `status.json` valid under the full contract in tests.\n- Metric 3: Reduction of unvalidated blockers in audits.\n",
  "fileStats": {
    "size": 5757,
    "lines": 106,
    "lastModified": "2026-02-13T19:16:28.531Z"
  },
  "comments": []
}