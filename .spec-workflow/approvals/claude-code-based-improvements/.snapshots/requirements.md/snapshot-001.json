{
  "id": "snapshot_1771009052051_p50f079oy",
  "approvalId": "approval_1771009052027_6dsvu4lip",
  "approvalTitle": "Requirements approval for claude-code-based-improvements",
  "version": 1,
  "timestamp": "2026-02-13T18:57:32.051Z",
  "trigger": "initial",
  "status": "pending",
  "content": "---\nspw:\n  schema: 1\n  spec: \"claude-code-based-improvements\"\n  doc: \"requirements\"\n  status: \"draft\"\n  source: \"spw:prd\"\n  updated_at: \"2026-02-13\"\n  inputs:\n    - \"https://github.com/anthropics/claude-code\"\n  open_questions: []\n  risk: \"medium\"\n---\n\n# Requirements Document\n\n## Product Context\n- Business problem: regras críticas ainda dependem demais de prompt markdown e têm enforcement parcial.\n- Feature objective: mover validações e guardrails para comandos CLI do `spw` (Go), deixando o fluxo mais determinístico.\n- Target audience: mantenedores do SPW e operadores dos comandos `spw:*`.\n\n## Scope\n### In Scope\n- Novo comando CLI para validação de prompts/workflows (`spw validate prompts`).\n- Contrato `status.json` v2 validado pelo CLI.\n- Gate de \"high-signal only\" para auditorias.\n- Limites explícitos de tentativas de revisão/replanejamento.\n- Cobertura de testes Go para novos contratos.\n\n### Out of Scope\n- Reescrever categorias de dispatch.\n- Alterar macrofluxo `prd -> plan -> exec -> checkpoint -> qa`.\n- Criar novos artefatos MCP além de `requirements.md`, `design.md`, `tasks.md`.\n\n## Functional Requirements\n\n### REQ-001 - Validação obrigatória de frontmatter em comandos\n- User story: como mantenedor, quero garantir contrato mínimo em `commands/spw/*.md`.\n- Acceptance criteria (EARS):\n  - WHEN `spw validate prompts` executar THEN cada comando MUST conter `description`, `argument-hint`, `allowed-tools`, `model`.\n  - IF algum campo obrigatório faltar THEN o comando falha com lista explícita de violações.\n- Priority: Must\n\n### REQ-002 - Validação de mirrors e assets embutidos\n- User story: como mantenedor, quero detectar drift automaticamente.\n- Acceptance criteria (EARS):\n  - WHEN `spw validate prompts --strict` executar THEN deve validar consistência entre `commands/`, `workflows/`, `copy-ready/` e assets embutidos do CLI.\n  - IF houver divergência THEN deve falhar com pares de caminhos divergentes.\n- Priority: Must\n\n### REQ-003 - Contrato obrigatório de status.json v2\n- User story: como orquestrador, quero status estruturado para decisões confiáveis.\n- Acceptance criteria (EARS):\n  - WHEN `spw tools dispatch-setup` gerar brief THEN deve exigir schema v2.\n  - WHEN `spw tools dispatch-read-status` ler status THEN valida tipos e campos obrigatórios.\n  - IF inválido THEN retorna `valid=false` e `errors[]` por campo.\n- Priority: Must\n\n### REQ-004 - Gate high-signal para auditorias\n- User story: como mantenedor, quero reduzir falso-positivo em comandos de auditoria.\n- Acceptance criteria (EARS):\n  - WHEN um finding for bloqueante THEN ele MUST ter `validated=true` e `confidence >= audit_min_confidence`.\n  - IF não atender threshold THEN vira warning, não blocker.\n- Priority: Must\n\n### REQ-005 - Limites de iteração\n- User story: como operador, quero evitar loops indefinidos.\n- Acceptance criteria (EARS):\n  - WHEN houver ciclos de revisão/replanejamento THEN MUST respeitar `max_revision_attempts` e `max_replan_attempts`.\n  - IF exceder limite THEN resultado MUST ser `WAITING_FOR_HUMAN_DECISION` com ação explícita.\n- Priority: Should\n\n### REQ-006 - Comando único para CI/local\n- User story: como time, quero uma checagem unificada por CLI.\n- Acceptance criteria (EARS):\n  - WHEN executar `spw validate prompts --json` THEN saída inclui `ok`, `summary`, `violations[]`, `stats`.\n- Priority: Should\n\n### REQ-007 - Atualização de documentação no mesmo patch\n- User story: como mantenedor, quero evitar drift doc/comportamento.\n- Acceptance criteria (EARS):\n  - WHEN comportamento/default/guardrail mudar THEN o patch MUST atualizar `README.md`, `AGENTS.md`, `docs/SPW-WORKFLOW.md`, `hooks/README.md`, `copy-ready/README.md`.\n- Priority: Must\n\n### REQ-008 - Cobertura de testes de regressão\n- User story: como mantenedor, quero segurança de evolução.\n- Acceptance criteria (EARS):\n  - WHEN rodar testes Go THEN contratos novos (validator/frontmatter/status v2/high-signal) MUST estar cobertos.\n- Priority: Must\n\n## Non-Functional Requirements\n- Performance: `spw validate prompts` deve completar em menos de 2 segundos no repositório padrão.\n- Security: validação local, sem chamadas externas.\n- Observability: mensagens de erro com regra + caminho + motivo.\n- Accessibility (when applicable): N/A (CLI).\n\n## Constraints and Assumptions\n- Technical constraints: foco em implementação via CLI Go (Cobra + pacotes internos).\n- External dependencies: sem dependência nova obrigatória além das já usadas.\n- Assumptions:\n  - Sem compat retroativa para schema antigo de `status.json`.\n  - Workflows markdown continuam declarativos; enforcement central no CLI.\n\n## Success Criteria\n- Metric 1: 100% de `commands/spw/*.md` com `allowed-tools` e `model`.\n- Metric 2: 100% de `status.json` válidos no schema v2 em testes.\n- Metric 3: redução de blockers não validados em auditorias.\n",
  "fileStats": {
    "size": 4878,
    "lines": 108,
    "lastModified": "2026-02-13T18:57:17.345Z"
  },
  "comments": []
}